// SPDX-FileCopyrightText: 2024 Fedor Logachev <not.fl3@gmail.com>
//
// SPDX-License-Identifier: MIT

"use strict";const AudioContext=window.AudioContext||window.webkitAudioContext;let audio_context,sounds=new Map,playbacks=[],sound_key_next=1,playback_key_next=1;function audio_init(){if(audio_context==null){audio_context=new AudioContext;let n=audio_context.listener;{let u=window.AudioContext||window.webkitAudioContext,t=new u;var e=function(o){console.log("fix"),audio_context.resume();var a=t.createBuffer(1,1,22050),d=t.createBufferSource();d.buffer=a,d.connect(t.destination),d.start?d.start(0):d.play?d.play(0):d.noteOn&&d.noteOn(0),document.removeEventListener("touchstart",e),document.removeEventListener("touchend",e),document.removeEventListener("mousedown",e),document.removeEventListener("keydown",e)};document.addEventListener("touchstart",e),document.addEventListener("touchend",e),document.addEventListener("mousedown",e),document.addEventListener("keydown",e)}}}function audio_add_buffer(e,n){let u=wasm_memory.buffer.slice(e,e+n),t=sound_key_next;return sound_key_next+=1,audio_context.decodeAudioData(u,function(o){sounds.set(t,o)},function(o){console.error("Failed to decode audio buffer",o)}),t}function audio_source_is_loaded(e){return sounds.has(e)&&sounds.get(e)!=null}function recycle_playback(){let e=playbacks.find(n=>n.sound_key===0);return e!=null?e.source=audio_context.createBufferSource():(e={sound_key:0,playback_key:0,source:audio_context.createBufferSource(),gain_node:audio_context.createGain(),ended:null},playbacks.push(e)),e}function stop(e){try{e.source.removeEventListener("ended",e.ended),e.source.disconnect(),e.gain_node.disconnect(),e.sound_key=0,e.playback_key=0}catch(n){console.error("Error stopping sound",n)}}function audio_play_buffer(e,n,u){let t=playback_key_next++,o=recycle_playback();o.sound_key=e,o.playback_key=t,o.source.connect(o.gain_node),o.gain_node.connect(audio_context.destination),o.gain_node.gain.value=n,o.source.loop=u,o.ended=function(){stop(o)},o.source.addEventListener("ended",o.ended);try{o.source.buffer=sounds.get(e),o.source.start(0)}catch(a){console.error("Error starting sound",a)}return t}function audio_source_set_volume(e,n){playbacks.forEach(u=>{u.sound_key===e&&(u.gain_node.gain.value=n)})}function audio_source_stop(e){playbacks.forEach(n=>{n.sound_key===e&&stop(n)})}function audio_source_delete(e){audio_source_stop(e),sounds.delete(e)}function audio_playback_stop(e){let n=playbacks.find(u=>u.playback_key===e);n!=null&&stop(n)}function audio_playback_set_volume(e,n){let u=playbacks.find(t=>t.playback_key===e);u!=null&&(u.gain_node.gain.value=n)}function register_plugin(e){e.env.audio_init=audio_init,e.env.audio_add_buffer=audio_add_buffer,e.env.audio_play_buffer=audio_play_buffer,e.env.audio_source_is_loaded=audio_source_is_loaded,e.env.audio_source_set_volume=audio_source_set_volume,e.env.audio_source_stop=audio_source_stop,e.env.audio_source_delete=audio_source_delete,e.env.audio_playback_stop=audio_playback_stop,e.env.audio_playback_set_volume=audio_playback_set_volume}miniquad_add_plugin({register_plugin,version:1,name:"macroquad_audio"});
